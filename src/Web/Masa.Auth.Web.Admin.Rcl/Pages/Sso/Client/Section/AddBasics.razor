@inherits AdminCompontentBase

<MRow>
    <MCol Md=12 Class="text-center">
        <DefaultUploadImage @bind-Value="Dto.LogoUri" Avatar Size="80" WhenFileChangeUpload />
    </MCol>
    <MCol Md=6>
        <STextField Required @bind-Value="Dto.ClientId" Label="@T("ClientId")" />
    </MCol>
    <MCol Md=6>
        <STextField Required @bind-Value="Dto.ClientName" Label="@T("ClientName")" />
    </MCol>
    <MCol Md=6>
        <STextField @bind-Value="Dto.ClientUri" Label="@T("ClientUri")" />
    </MCol>
    <MCol Md=6>
        <MCheckbox @bind-Value="Dto.RequireConsent" Label="@T("RequireConsent")"></MCheckbox>
    </MCol>
</MRow>
<MRow>
    <MCol Md=6>
        <STextField @bind-Value="Dto.RedirectUri" Label="@T("CallBackRedirectUri")" Suffix="@redirectUriSuffix"
                          AppendOuterIcon="@IconConstants.Add" OnAppendOuterClick="AddCallBackRedirectUri" />
        @foreach (var uri in Dto.RedirectUris)
        {
            <STextField HideDetails="true" Value="uri" Readonly Class="mt-2" AppendOuterIcon="mdi-close-circle" OnAppendOuterClick="()=>RemoveCallBackRedirectUri(uri)" />
        }
    </MCol>
    <MCol Md=6>
        <STextField @bind-Value="Dto.PostLogoutRedirectUri" Label="@T("PostLogoutRedirectUri")" Suffix="@logoutRedirectUriSuffix"
                          AppendOuterIcon="@IconConstants.Add" OnAppendOuterClick="AddLogoutRedirectUri" />
        @foreach (var uri in Dto.PostLogoutRedirectUris)
        {
            <STextField Dense HideDetails="true" Value="uri" Readonly Class="mt-2" AppendOuterIcon="mdi-close-circle" OnAppendOuterClick="()=>RemoveLogoutRedirectUri(uri)" />
        }
    </MCol>
</MRow>
<MRow>
    <MCol Md=12>
        <STextField @bind-Value="Dto.Description" Label="@T("Description")" />
    </MCol>
</MRow>

@code {
    [Parameter]
    public AddClientBasicDto Dto { get; set; } = new();

    [Parameter]
    public EventCallback<AddClientBasicDto> DtoChanged { get; set; }

    readonly string redirectUriSuffix = "/signin-oidc";
    readonly string logoutRedirectUriSuffix = "/signout-callback-oidc";

    private void AddCallBackRedirectUri()
    {
        if (!string.IsNullOrWhiteSpace(Dto.RedirectUri) && Dto.RedirectUris.IndexOf(Dto.RedirectUri) < 0)
        {
            Dto.RedirectUris.Add($"{Dto.RedirectUri.TrimEnd('/')}{redirectUriSuffix}");
            Dto.RedirectUri = string.Empty;
        }
    }

    private void AddLogoutRedirectUri()
    {
        if (!string.IsNullOrWhiteSpace(Dto.PostLogoutRedirectUri) &&
            Dto.PostLogoutRedirectUris.IndexOf(Dto.PostLogoutRedirectUri) < 0)
        {
            Dto.PostLogoutRedirectUris.Add($"{Dto.PostLogoutRedirectUri.TrimEnd('/')}{logoutRedirectUriSuffix}");
            Dto.PostLogoutRedirectUri = string.Empty;
        }
    }

    private void RemoveCallBackRedirectUri(string val)
    {
        Dto.RedirectUris.Remove(val);
    }

    private void RemoveLogoutRedirectUri(string val)
    {
        Dto.PostLogoutRedirectUris.Remove(val);
    }
}