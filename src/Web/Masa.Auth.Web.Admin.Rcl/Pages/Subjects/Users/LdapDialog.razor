@inherits AdminCompontentBase

<SheetDialog Value=Show Title="@T("Configure Domain Account")" ValueChanged="ShowChanged">
    <MCard class="pt-9 d-flex flex-column full-height" Style="margin-left:228px;margin-right:228px;">
        <MCardText>
            <MForm Model=_ldapDetailDto EnableValidation @ref="_form">
                <MRow>
                    <MCol Md=12>
                        <DefaultTextField Label="@T("Ldap Root User")" @bind-Value="_ldapDetailDto.RootUserDn"></DefaultTextField>
                    </MCol>
                    <MCol Md=12>
                        <DefaultTextField Label="@T("Ldap Root User Pwd")" @bind-Value="_ldapDetailDto.RootUserPassword"></DefaultTextField>
                    </MCol>
                    <MCol Md=12 Class="d-flex align-center">
                        <DefaultTextField Label="@T("Server Address")" Style="width:calc(100vh - 320px);" @bind-Value="_ldapDetailDto.ServerAddress"></DefaultTextField>
                        <DefaultTextField Style="max-width:140px;" Class="mx-4" Clearable=false Label="@T("Server Port")" @bind-Value="_ldapDetailDto.ServerPort"></DefaultTextField>
                        <MCheckbox @bind-Value="_ldapDetailDto.IsLdaps" Class="mt-0" Style="width:140px;" Label="@T("Is Ldaps")"></MCheckbox>
                    </MCol>
                    <MCol Md=12>
                        <DefaultTextField Label="@T("BaseDn")" @bind-Value="_ldapDetailDto.BaseDn"></DefaultTextField>
                    </MCol>
                    <MCol Md=12>
                        <DefaultTextField Label="@T("User Search BaseDn")" @bind-Value="_ldapDetailDto.UserSearchBaseDn"></DefaultTextField>
                    </MCol>
                    <MCol Md=12>
                        <DefaultTextField Label="@T("Group Search BaseDn")" @bind-Value="_ldapDetailDto.GroupSearchBaseDn"></DefaultTextField>
                    </MCol>
                </MRow>
            </MForm>
        </MCardText>
        <MCardActions class="d-flex align-center mb-12 px-6">
            <MSpacer />
            <MButton class="rounded-pill mr-6" MinWidth="100" OnClick="ConnectTest">@T("Test")</MButton>
            <MButton class="rounded-pill primary" MinWidth="100" OnClick="LdapSubmit">@T("Submit")</MButton>
        </MCardActions>
    </MCard>
</SheetDialog>

@code {
    MForm _form = null!;
    LdapDetailDto _ldapDetailDto = new();

    ThirdPartyIdpService ThirdPartyIdpService => AuthCaller.ThirdPartyIdpService;

    [Parameter]
    public bool Show { get; set; }

    [Parameter]
    public EventCallback<bool> ShowChanged { get; set; }

    public async Task OpenAsync()
    {
        _ldapDetailDto = await ThirdPartyIdpService.GetLdapDetailAsync();
        Show = true;
        StateHasChanged();
    }

    private async Task ConnectTest()
    {
        if (!await _form.ValidateAsync())
        {
            return;
        }

        try
        {
            await ThirdPartyIdpService.LdapConnectTestAsync(_ldapDetailDto);
            OpenSuccessMessage(T("Connect Success"));
        }
        catch
        {
            OpenErrorMessage(T("Connect Error"));
        }
    }

    private async Task LdapSubmit()
    {
        if (!await _form.ValidateAsync())
        {
            return;
        }
        await ThirdPartyIdpService.LdapUpsertAsync(_ldapDetailDto);
        OpenSuccessMessage(T("Ldap Account Synchroniz Success"));
    }
}
