@inherits AdminCompontentBase

<SheetDialog Value=Show Title="@T("Configure Domain Account")" ValueChanged="ShowChanged">
    <MCard class="pt-9 d-flex flex-column full-height" Style="margin-left:228px;margin-right:228px;">
        <MCardText>
            <MForm Model=lDAPDetailDto EnableValidation @ref="_form">
                <MRow>
                    <MCol Md=12>
                        <DefaultTextField Label="@T("LDAP Root User")" @bind-Value="lDAPDetailDto.RootUserDn"></DefaultTextField>
                    </MCol>
                    <MCol Md=12>
                        <DefaultTextField Label="@T("LDAP Root User Pwd")" @bind-Value="lDAPDetailDto.RootUserPassword"></DefaultTextField>
                    </MCol>
                    <MCol Md=12 Class="d-flex align-center">
                        <DefaultTextField Label="@T("Server Address")" Style="width:calc(100vh - 320px);" @bind-Value="lDAPDetailDto.ServerAddress"></DefaultTextField>
                        <DefaultTextField Style="max-width:140px;" Class="mx-4" Clearable=false Label="@T("Server Port")" @bind-Value="lDAPDetailDto.ServerPort"></DefaultTextField>
                        <MCheckbox @bind-Value="lDAPDetailDto.IsLdaps" Class="mt-0" Style="width:140px;" Label="@T("Is Ldaps")"></MCheckbox>
                    </MCol>
                    <MCol Md=12>
                        <DefaultTextField Label="@T("BaseDn")" @bind-Value="lDAPDetailDto.BaseDn"></DefaultTextField>
                    </MCol>
                    <MCol Md=12>
                        <DefaultTextField Label="@T("User Search BaseDn")" @bind-Value="lDAPDetailDto.UserSearchBaseDn"></DefaultTextField>
                    </MCol>
                    <MCol Md=12>
                        <DefaultTextField Label="@T("Group Search BaseDn")" @bind-Value="lDAPDetailDto.GroupSearchBaseDn"></DefaultTextField>
                    </MCol>
                </MRow>
            </MForm>
        </MCardText>
        <MCardActions class="d-flex align-center mb-12 px-6">
            <MSpacer />
            <MButton class="rounded-pill mr-6" MinWidth="100" OnClick="ConnectTest">@T("Test")</MButton>
            <MButton class="rounded-pill primary" MinWidth="100" OnClick="LdapSubmit">@T("Submit")</MButton>
        </MCardActions>
    </MCard>
</SheetDialog>

@code {
    MForm _form = null!;
    LdapDetailDto lDAPDetailDto = new();

    ThirdPartyIdpService ThirdPartyIdpService => AuthCaller.ThirdPartyIdpService;

    [Parameter]
    public bool Show { get; set; }

    [Parameter]
    public EventCallback<bool> ShowChanged { get; set; }

    private async Task ConnectTest()
    {
        if (!await _form.ValidateAsync())
        {
            return;
        }

        try
        {
            await ThirdPartyIdpService.LdapConnectTestAsync(lDAPDetailDto);
            OpenSuccessMessage(T("Connect Success"));
        }
        catch
        {
            OpenErrorMessage(T("Connect Error"));   
        }
    }

    private async Task LdapSubmit()
    {
        if (!await _form.ValidateAsync())
        {
            return;
        }
        await ThirdPartyIdpService.LdapUpsertAsync(lDAPDetailDto);
        OpenSuccessMessage("");
    }
}
